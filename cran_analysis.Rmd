---
title: "Analysis"
author: "Thomas Vroylandt"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

```{r packages}
library(tidyverse)
library(reactable)
library(tidygraph)
library(ggraph)
```


```{r import}
df_cran_pkg_infos <- read_rds("data/cran_pkg_infos.rds")
df_cran_pkg_mails <- read_rds("data/cran_pkg_mails.rds")
df_cran_pkg_authors <- read_rds("data/cran_pkg_authors.rds")
df_cran_pkg_deps <- read_rds("data/cran_pkg_deps.rds")
df_cran_pkg_logs <- read_rds("data/cran_pkg_logs.rds")
df_cran_pkg_views <- read_rds("data/cran_pkg_views.rds")
```

https://xkcd.com/2347/

## What are the main packages ?

By median download (by months > 0) rather than total or mean because some strange things on packages like `tidyverse` or `aws.s3`.

For packages with min_year as 2013, it could be before (since mirror started end 2012). Count of authors is based on role NA, cre, aut, ctb.

```{r main_pkgs}
# median download
main_pkgs <- df_cran_pkg_logs %>%
  filter(nb_download > 0) %>%
  group_by(package) %>%
  summarise(median_download = median(nb_download),
            min_year = min(year)) %>%
  ungroup() %>%
  arrange(desc(median_download))

# nb authors by package
df_nb_authors <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb") | is.na(role)) %>%
  distinct(package, authors) %>%
  group_by(package) %>%
  count(name = "nb_authors") %>%
  ungroup()

# nb authors by package
df_nb_deps <- df_cran_pkg_deps %>%
  filter(pkg_dep != "R" &
           type_dep %in% c("depends", "imports", "linking_to")) %>%
  group_by(package) %>%
  count(name = "nb_deps") %>%
  ungroup()

df_nb_is_deps <- df_cran_pkg_deps %>%
  filter(type_dep %in% c("depends", "imports", "linking_to")) %>%
  group_by(pkg_dep) %>%
  count(name = "nb_is_deps") %>%
  ungroup()

# views as list to print
list_views <- df_cran_pkg_views %>%
  group_by(pkg_name) %>%
  summarise(list_views = paste0(views, collapse = " \n")) %>%
  ungroup()

# adding variables
main_pkgs_table <- main_pkgs %>%
  left_join(df_cran_pkg_infos, by = c("package")) %>%
  left_join(df_nb_authors, by = c("package")) %>%
  left_join(df_nb_deps, by = c("package")) %>%
  left_join(df_nb_is_deps, by = c("package" = "pkg_dep")) %>%
  left_join(list_views, by = c("package" = "pkg_name")) %>%
  select(
    package,
    title,
    median_download,
    min_year,
    nb_authors,
    nb_deps,
    nb_is_deps,
    list_views
  ) %>%
  replace_na(list(
    nb_authors = 0,
    nb_deps = 0,
    nb_is_deps = 0
  ))

# table
main_pkgs_table %>%
  reactable()
```

## What are the central packages ?

Weighted centrality by deps + weight correction ?

Authors network -> collaboration

```{r}
# node list
node_list_authors_0 <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>% 
  distinct(authors, package) %>% 
  group_by(authors) %>% 
  count(name = "n_package") %>% 
  ungroup()

node_list_authors_1 <-  df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>%
  group_by(authors, role) %>%
  summarise(n_role = n()) %>%
  ungroup() %>%
  pivot_wider(
    names_from = role,
    values_from = n_role,
    values_fill = list(n_role = 0)
  ) %>% 
  mutate(perc_cre = cre / (ctb + aut ) * 100) %>% 
  select(authors, perc_cre)

node_list_authors <- node_list_authors_0 %>% 
  left_join(node_list_authors_1, by = "authors") %>% 
  filter(n_package >= 15)

# edge list
edge_list_authors <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>%
  distinct(package, authors) %>%
  left_join(df_cran_pkg_authors %>%
              select(package, authors), by = "package") %>%
  filter(authors.x != authors.y) %>%
  group_by(authors.x, authors.y) %>%
  count(name = "n_link") %>%
  ungroup() %>%
  rename(from = authors.x,
         to = authors.y) %>%
  filter(from %in% node_list_authors$authors &
           to %in% node_list_authors$authors)

# format graph
graph <-
  tbl_graph(nodes = node_list_authors, edges = edge_list_authors)

# plot using ggraph
ggraph(graph, layout = 'kk') +
  geom_edge_fan(aes(alpha = n_link)) +
  geom_node_point(aes(size = n_package, color = -perc_cre)) +
  theme_graph()
```

Authors network -> dependencies : who develop package on which other packages are built on ?

```{r}
deps_pkg <- df_cran_pkg_deps %>% 
  filter(type_dep %in% c("depends", "imports", "linking_to")) %>% 
  distinct(package, pkg_dep) %>% 
  group_by(pkg_dep) %>% 
  count(name = "n_pkg_dep", sort = TRUE) %>% 
  ungroup() %>% 
  filter(pkg_dep != "" & pkg_dep != "R")

deps_pkg %>%
  left_join(df_cran_pkg_authors, by = c("pkg_dep" = "package")) %>%
  distinct() %>% 
  filter(role %in% c("cre")) %>% 
  group_by(authors) %>% 
  summarise(n_package = n(),
            n_pkg_dep = sum(n_pkg_dep)) %>% 
  ungroup() %>% 
  arrange(desc(n_pkg_dep))

pkg_dep_author <- deps_pkg %>%
  left_join(df_cran_pkg_authors, by = c("pkg_dep" = "package")) %>%
  distinct() %>% 
  filter(role %in% c("cre"))


```


## Mails

```{r}
df_cran_pkg_mails %>% 
  group_by(mail_domain) %>% 
  count(sort = TRUE) %>% 
  filter(str_detect(mail_domain, "uni|edu"))

df_cran_pkg_mails %>% 
  mutate(mail_domain = str_remove_all(mail_domain, "'|\\\t|cautcre")) %>% 
  group_by(mail_domain) %>% 
  count(sort = TRUE) %>% 
  filter(!str_detect(mail_domain, ".edu|uni")) %>% 
  head(20)

mails_first <- df_cran_pkg_mails %>%
  mutate(mail_domain = str_remove_all(mail_domain, "'|\\\t|cautcre")) %>%
  group_by(package) %>%
  slice(1) %>%
  group_by(mail_domain) %>%
  count(sort = TRUE) %>% 
  ungroup()
```

## Dependencies network

```{r}
df_cran_pkg_deps
```

## Map the peoples 

```{r}
# create edge list
df_cran_pkg_authors_distinct <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre")) %>% 
  distinct(package, authors)

df_cran_pkg_authors_links <- df_cran_pkg_authors_distinct %>%
  full_join(df_cran_pkg_authors_distinct, by = c("package")) %>%
  group_by(authors.x, authors.y) %>%
  count() %>%
  filter(authors.x != authors.y) %>%
  ungroup()


# create node list

```

## Score of dependencies 

How much of the package download are explainable as download as a dependency ?
Create a score.

```{r}
# logs nb
download_2019 <- df_cran_pkg_logs %>% 
  filter(year == 2019) %>% 
  group_by(package) %>% 
  summarise(nb_download = sum(nb_download, na.rm = TRUE))

# distinct deps
df_cran_pkg_deps_distinct <- df_cran_pkg_deps %>%
  filter(type_dep != "suggests" & pkg_dep != "R" & pkg_dep != "") %>%
  distinct(package, pkg_dep)

# score
df_cran_pkg_deps_score <- df_cran_pkg_deps_distinct %>%
  left_join(download_2019, by = c("package")) %>%
  group_by(pkg_dep) %>%
  summarise(nb_download_dep = sum(nb_download, na.rm = TRUE)) %>%
  ungroup() %>%
  full_join(
    df_cran_pkg_infos %>%
      distinct(package) %>%
      left_join(download_2019, by = "package") %>%
      rename(nb_download_pkg = nb_download),
    by = c("pkg_dep" = "package")
  ) %>%
  replace_na(list(nb_download_pkg = 0, nb_download_dep = 0)) %>%
  left_join(df_cran_pkg_deps_distinct %>%
              group_by(pkg_dep) %>%
              count(name = "nb_is_dep"),
            by = "pkg_dep") %>%
  rename(package = pkg_dep) %>%
  mutate(score_dep = nb_download_dep / nb_download_pkg,
         download_self = nb_download_pkg - nb_download_dep)

# add a weight by number of dep ?

# here lies everything
df_cran_pkg_deps_score %>% 
  filter(!is.infinite(score_dep)) %>% 
  arrange(download_self) %>% 
  head(20)

# nb_download dep -> number of download for the packages that have the package as dep
# nb_downlod_pkg -> number of download for the package
# score_dep : share of the package download as a dep (estimate) -> 0 = pkg for itself, 1 + = pkg as dep
```

Number of collaborator / authors on main packages ?

Get main packages through page RAnk or other centrality ?

+ who are maintaining both of them ? People ? Organizations ? Collaborations ?
+ by thematic / views ?
+ who collaborate with whom ?


---
title: "Beyond R Packages - An History of Collaborations"
author: "Thomas Vroylandt"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

```{r import}
# packages
library(tidyverse)
library(reactable)
library(tidygraph)
library(ggraph)

# import
df_cran_pkg_infos <- read_rds("data/cran_pkg_infos.rds")
df_cran_pkg_mails <- read_rds("data/cran_pkg_mails.rds")
df_cran_pkg_authors <- read_rds("data/cran_pkg_authors.rds")
df_cran_pkg_deps <- read_rds("data/cran_pkg_deps.rds")
df_cran_pkg_logs <- read_rds("data/cran_pkg_logs.rds")
df_cran_pkg_views <- read_rds("data/cran_pkg_views.rds")
```

For all R users, CRAN is the place were you can find most of the packages you need to run code. Last month, I saw this Xkcd drawing :

![](img/dependency.png)

And this remind me of something : behind packages, you can find people. And this people are at the heart of all your analytics pipelines because they build, maintain and develop R packages. It's their ideas and their work, discussion and collaborations that made R as it is. One example of it is the [fantastic story of the pipe](http://adolfoalvarez.cl/plumbers-chains-and-famous-painters-the-history-of-the-pipe-operator-in-r/) (`%>%`) by Adolfo Alvarez.

Let's talk a bit about this people and their packages !

## Which packages are we talking about ?

Not all packages on CRAN are equal. They are all useful and all needed a big bunch of work. But some are more useful than others, also because they are more general.

I try to appreciate it by comparing two things :

+ how much the package has been downloaded ?
+ how many packages use the package as a dependency ?

For the first one, I used `{cranlogs}`, a package which show the download statistics for the RStudio CRAN mirror, from 2013 to now. It's not all the CRAN downloads but it's a nice part of them. We choose to compute the median download by month for each package, since it's first appearance (so for months with more than 0 download). I did so since we got some strange stats for packages like `{tidyverse}` with an incredible amount of downloads in november 2018 or a big amount of downloads for `{aws.s3}` over the last year that I couldn't understand.

For the dependency count, I used some centrality measures from graph network theory. What is important to me is to know how much times the package is listed as a dependency (so in-degree centrality), how many dependency it has (out-degree centrality) and if the package is "important" in the global network of the dependency graph. For this last measure, I used PageRank centrality, the same algorithm as Google.

With all of that, we get the following table with all the packages on CRAN :

+ **add centrality**
+ **tab form**

```{r main_pkgs}
# median download
main_pkgs <- df_cran_pkg_logs %>%
  filter(nb_download > 0) %>%
  group_by(package) %>%
  summarise(median_download = median(nb_download),
            min_year = min(year)) %>%
  ungroup() %>%
  arrange(desc(median_download))

# median download of dep
df_mean_median_is_dep <- df_cran_pkg_deps %>%
  filter(type_dep %in% c("depends", "imports", "linking_to")) %>%
  left_join(main_pkgs, by = c("package")) %>% 
  group_by(pkg_dep) %>% 
  summarise(mean_median = mean(median_download)) %>% 
  ungroup()

# nb authors by package
df_nb_authors <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre") | is.na(role)) %>%
  distinct(package, authors) %>%
  group_by(package) %>%
  count(name = "nb_authors") %>%
  ungroup()

# nb authors by package
df_nb_deps <- df_cran_pkg_deps %>%
  filter(pkg_dep != "R" &
           type_dep %in% c("depends", "imports", "linking_to")) %>%
  group_by(package) %>%
  count(name = "nb_deps") %>%
  ungroup()

df_nb_is_deps <- df_cran_pkg_deps %>%
  filter(type_dep %in% c("depends", "imports", "linking_to")) %>%
  group_by(pkg_dep) %>%
  count(name = "nb_is_deps") %>%
  ungroup()

# views as list to print
list_views <- df_cran_pkg_views %>%
  group_by(pkg_name) %>%
  summarise(list_views = paste0(views, collapse = " \n")) %>%
  ungroup()

# adding variables
main_pkgs_full <- main_pkgs %>%
  full_join(df_cran_pkg_infos, by = c("package")) %>%
  left_join(df_nb_authors, by = c("package")) %>%
  left_join(df_nb_deps, by = c("package")) %>%
  left_join(df_nb_is_deps, by = c("package" = "pkg_dep")) %>%
  left_join(list_views, by = c("package" = "pkg_name")) %>%
  select(
    package,
    title,
    median_download,
    min_year,
    nb_authors,
    nb_deps,
    nb_is_deps,
    list_views
  ) %>%
  replace_na(list(
    median_download = 0,
    nb_authors = 0,
    nb_deps = 0,
    nb_is_deps = 0
  )) %>% 
  group_by(package) %>% 
  slice(1) %>% 
  ungroup()

# table
main_pkgs_full %>%
  reactable()
```

I gathered the main infos in a graph, crossing centrality (in-degree) and popularity (downloads). I annotate some main areas :

+ on the right of the graph, a lot of packages, very popular like `{dplyr}` or `{ggplot2}` (the whole `{tidyverse}` collection in fact) or `{httr}`. This packages are direct downloads from the people. They are widely-used. A lot of packages depends of them.

+ on the top-left, some more unknown packages to neophytes like `{ellipsis}`, `{vctrs}`, `{pillar}`, etc. This packages have a lot of downloads but are only listed as a dependency by a few but very important packages. In fact they are more "infrastructure" packages. They are the foundations of some more-used packages and they hide the more low-level functions. So we can guess that the downloads are not direct downloads but come from the download of other packages.

+ some other packages, in the middle between the two above categories, like `{rlang}` or `{Rcpp}` could be the most important R packages. We should also notice that they have a 0 out-degree centrality, so they depends on zero other package (they are root packages).

**work more on the graph**
**some rewriting of explanations**

```{r central_pkgs}
# base pkgs
base_r_pkgs <- c(
  "base",
  "boot",
  "class",
  "cluster",
  "codetools",
  "compiler",
  "datasets",
  "foreign",
  "graphics",
  "grDevices",
  "grid",
  "KernSmooth",
  "lattice",
  "MASS",
  "Matrix",
  "methods",
  "mgcv",
  "nlme",
  "nnet",
  "parallel",
  "rpart",
  "spatial",
  "splines",
  "stats",
  "stats4",
  "survival",
  "tcltk",
  "tools",
  "utils"
)

# edge list deps
edge_list_deps <- df_cran_pkg_deps %>%
  filter(
    pkg_dep != "R" &
      type_dep %in% c("depends", "imports", "linking_to") &
      !pkg_dep %in% base_r_pkgs
  ) %>%
  distinct(package, pkg_dep) %>%
  rename(from = package,
         to = pkg_dep) %>%
  as_tbl_graph(directed = TRUE)

# # add nodes info
# graph_deps <- edge_list_deps %>%
#   rename(package = name) %>%
#   graph_join(tbl_graph(nodes = main_pkgs_full), by = "package")

# calculate centrality
graph_deps_central <- edge_list_deps %>%
  activate(nodes) %>%
  mutate(
    c_degree_out = centrality_degree(mode = "out"),
    c_degree_in = centrality_degree(mode = "in"),
    c_betweenness = centrality_betweenness(),
    c_pagerank = centrality_pagerank()
  )

#rstudio pkg
df_rstudio_employees <- read_rds("data/rstudio_employees.rds")

rstudio_pkg <- df_cran_pkg_authors %>% 
  filter(authors %in% df_rstudio_employees$name & (role %in% c("aut", "cre") | is.na(role))) %>% 
  distinct(package) %>% 
  pull()

# graph
graph_deps_central %>%
  as_tibble() %>%
  left_join(main_pkgs_full, by = c("name" = "package")) %>%
  left_join(df_mean_median_is_dep, by = c("name" = "pkg_dep")) %>%
  mutate(nb_authors_d = santoku::chop(
    nb_authors,
    breaks = c(0, 2, 4, 6, 11, 100),
    labels = c("1", "2-3", "4-5", "6-10", "11+")
  )) %>%
  replace_na(list(
    median_download = 0,
    c_pagerank = 0,
    mean_median = 1
  )) %>%
  filter(c_degree_in > 0 & median_download > 0) %>%
  ggplot(aes(
    x = c_degree_in,
    y = median_download ,
    size = c_pagerank,
    color = c_degree_out
  )) +
  annotate(
    geom = "rect",
    xmin = 220,
    xmax = 2200,
    ymin = 0,
    ymax = 310000,
    alpha = 0.1,
    fill = "#741336"
  ) +
  annotate(
    geom = "rect",
    xmin = -50,
    xmax = 180,
    ymin = 230000,
    ymax = 900000,
    alpha = 0.1,
    fill = "#8445ff"
  ) +
  geom_point(
    data = . %>% filter(!c_degree_in > 200 &
                          !median_download > 200000),
    alpha = 0.5,
    color = "lightgrey"
  ) +
  ggrepel::geom_text_repel(data = . %>% filter(c_degree_in > 200 |
                                                 median_download > 200000),
                           aes(label = name)) +
  scale_size_continuous(range = c(1, 12)) +
  scale_color_viridis_c(name = "", direction = -1) +
  guides(size = FALSE) +
  theme_minimal()
```

## And the authors ?

make number of authors for the top packages of each categories + who  + organisation ?

```{r}
main_pkgs_full %>%
  mutate(categ = case_when(
    package %in% c(
      "lifecycle",
      "vctrs",
      "ellipsis",
      "pillar",
      "fansi",
      "glue",
      "cli",
      "xfun",
      "tidyselect",
      "askpass",
      "tinytex",
      "processx",
      "lazyeval"
    ) ~ "top left",
    package %in% c(
      "ggplot",
      "dplyr",
      "magrittr",
      "stringr",
      "purrr",
      "plyr",
      "reshape2",
      "data.table",
      "tidyr",
      "shiny",
      "httr",
      "mvtnorm",
      "foreach",
      "sp",
      "igraph",
      "lubridate",
      "RColorBrewer",
      "scales",
      "readr",
      "knitr",
      "zoo",
      "gridExtra",
      "raster",
      "doParallel"
    ) ~ "right",
    package %in% c("rlang", "tibble", "Rcpp", "jsonlite", "R6") ~ "middle"
  )) %>% 
  filter(!is.na(categ)) %>%
  ggplot(aes(x = package, y = nb_authors, fill = as.character(min_year))) +
  geom_col() +
  coord_flip() +
  theme_minimal()
```


## Authors collaborations



Number of collaborator / authors on main packages ?

+ who are maintaining both of them ? People ? Organizations ? Collaborations ?
+ by thematic / views ?
+ who collaborate with whom ?
+ path from package to people behind them ! = community

```{r, eval = FALSE}
# node list
node_list_authors_0 <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>% 
  distinct(authors, package) %>% 
  group_by(authors) %>% 
  count(name = "n_package") %>% 
  ungroup()

node_list_authors_1 <-  df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>%
  group_by(authors, role) %>%
  summarise(n_role = n()) %>%
  ungroup() %>%
  pivot_wider(
    names_from = role,
    values_from = n_role,
    values_fill = list(n_role = 0)
  ) %>% 
  mutate(perc_cre = cre / (ctb + aut ) * 100) %>% 
  select(authors, perc_cre)

node_list_authors <- node_list_authors_0 %>% 
  left_join(node_list_authors_1, by = "authors") %>% 
  filter(n_package >= 15)

# edge list
edge_list_authors <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre", "ctb")) %>%
  distinct(package, authors) %>%
  left_join(df_cran_pkg_authors %>%
              select(package, authors), by = "package") %>%
  filter(authors.x != authors.y) %>%
  group_by(authors.x, authors.y) %>%
  count(name = "n_link") %>%
  ungroup() %>%
  rename(from = authors.x,
         to = authors.y) %>%
  filter(from %in% node_list_authors$authors &
           to %in% node_list_authors$authors)

# format graph
graph <-
  tbl_graph(nodes = node_list_authors, edges = edge_list_authors)

# plot using ggraph
ggraph(graph, layout = 'kk') +
  geom_edge_fan(aes(alpha = n_link)) +
  geom_node_point(aes(size = n_package, color = -perc_cre)) +
  theme_graph()
```

Authors network -> dependencies : who develop package on which other packages are built on ?

```{r, eval = FALSE}
deps_pkg <- df_cran_pkg_deps %>% 
  filter(type_dep %in% c("depends", "imports", "linking_to")) %>% 
  distinct(package, pkg_dep) %>% 
  group_by(pkg_dep) %>% 
  count(name = "n_pkg_dep", sort = TRUE) %>% 
  ungroup() %>% 
  filter(pkg_dep != "" & pkg_dep != "R")

deps_pkg %>%
  left_join(df_cran_pkg_authors, by = c("pkg_dep" = "package")) %>%
  distinct() %>% 
  filter(role %in% c("cre")) %>% 
  group_by(authors) %>% 
  summarise(n_package = n(),
            n_pkg_dep = sum(n_pkg_dep)) %>% 
  ungroup() %>% 
  arrange(desc(n_pkg_dep))

pkg_dep_author <- deps_pkg %>%
  left_join(df_cran_pkg_authors, by = c("pkg_dep" = "package")) %>%
  distinct() %>% 
  filter(role %in% c("cre"))


```


## Map the peoples 

```{r, eval = FALSE}
# create edge list
df_cran_pkg_authors_distinct <- df_cran_pkg_authors %>%
  filter(role %in% c("aut", "cre")) %>% 
  distinct(package, authors)

df_cran_pkg_authors_links <- df_cran_pkg_authors_distinct %>%
  full_join(df_cran_pkg_authors_distinct, by = c("package")) %>%
  group_by(authors.x, authors.y) %>%
  count() %>%
  filter(authors.x != authors.y) %>%
  ungroup()


# create node list

```

## Mails

```{r, eval = FALSE}
df_cran_pkg_mails %>% 
  group_by(mail_domain) %>% 
  count(sort = TRUE) %>% 
  filter(str_detect(mail_domain, "uni|edu"))

df_cran_pkg_mails %>% 
  mutate(mail_domain = str_remove_all(mail_domain, "'|\\\t|cautcre")) %>% 
  group_by(mail_domain) %>% 
  count(sort = TRUE) %>% 
  filter(!str_detect(mail_domain, ".edu|uni")) %>% 
  head(20)

mails_first <- df_cran_pkg_mails %>%
  mutate(mail_domain = str_remove_all(mail_domain, "'|\\\t|cautcre")) %>%
  group_by(package) %>%
  slice(1) %>%
  group_by(mail_domain) %>%
  count(sort = TRUE) %>% 
  ungroup()
```
